<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Color Detection Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 1) Define Module with onRuntimeInitialized so we know when OpenCV is ready -->
  <script>
    let cvReady = false;
    var Module = {
      onRuntimeInitialized() {
        cvReady = true;
        console.log("OpenCV.js runtime has initialized!");
      }
    };
  </script>

  <!-- 2) Load opencv.js (no async/defer) so we guarantee it loads before our code runs -->
  <script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0; 
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    header {
      background: #333;
      color: #fff;
      width: 100%;
      text-align: center;
      padding: 15px;
    }
    h1 {
      margin: 0;
      font-weight: normal;
    }
    #main-content {
      width: 90%;
      max-width: 1000px;
      margin: 20px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      position: relative;
    }
    #controls-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    #upload-button {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    #canvas-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: 2px solid #ccc;
      border-radius: 6px;
      width: 600px;
      height: 400px; 
      margin: 0 auto;
      background: #eee;
    }
    #snapshot-canvas {
      background: #ddd;
    }
    #spinner {
      width: 36px;
      height: 36px;
      border: 4px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      margin: 10px auto;
      display: none;
      position: absolute;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    #color-results {
      margin-top: 20px;
    }
    .color-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .color-box {
      width: 30px;
      height: 30px;
      margin-right: 10px;
      border: 1px solid #aaa;
    }
    .color-info {
      font-size: 0.9em;
      color: #333;
    }
  </style>
</head>
<body>
<header>
  <h1>Color Detection Tool</h1>
</header>

<div id="main-content">
  <div id="controls-container">
    <input type="file" id="upload-button" accept="image/*" />
  </div>

  <div id="canvas-container">
    <canvas id="snapshot-canvas"></canvas>
    <div id="spinner"></div>
  </div>

  <div id="color-results"></div>
</div>

<!-- 3) Our main script that depends on OpenCV -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const uploadButton    = document.getElementById('upload-button');
  const spinner         = document.getElementById('spinner');
  const snapshotCanvas  = document.getElementById('snapshot-canvas');
  const ctx             = snapshotCanvas.getContext('2d');
  const colorResults    = document.getElementById('color-results');

  // Small dictionary for approximate color names (demo). 
  // For bigger coverage, you can expand this array or use a color library.
  const colorNameMap = [
    { name: "White",   rgb: [255,255,255] },
    { name: "Black",   rgb: [0,0,0]       },
    { name: "Red",     rgb: [255,0,0]     },
    { name: "Green",   rgb: [0,255,0]     },
    { name: "Blue",    rgb: [0,0,255]     },
    { name: "Yellow",  rgb: [255,255,0]   },
    { name: "Cyan",    rgb: [0,255,255]   },
    { name: "Magenta", rgb: [255,0,255]   },
    { name: "Gray",    rgb: [128,128,128] },
    { name: "Maroon",  rgb: [128,0,0]     },
    { name: "Olive",   rgb: [128,128,0]   },
    { name: "Navy",    rgb: [0,0,128]     },
    // Add more if desired...
  ];

  // Approximate color name from our list above
  function approximateColorName(r, g, b) {
    let closestName = "Unknown";
    let minDist = Infinity;
    colorNameMap.forEach(({ name, rgb }) => {
      let dr = r - rgb[0];
      let dg = g - rgb[1];
      let db = b - rgb[2];
      let dist = dr*dr + dg*dg + db*db;
      if(dist < minDist) {
        minDist = dist;
        closestName = name;
      }
    });
    return closestName;
  }

  // Convert (r,g,b) to #RRGGBB
  function rgbToHex(r, g, b) {
    let toHex = c => {
      let hex = c.toString(16);
      return hex.length === 1 ? "0" + hex : hex;
    };
    return "#" + toHex(r) + toHex(g) + toHex(b);
  }

  // When user selects a file
  uploadButton.addEventListener('change', (evt) => {
    const file = evt.target.files[0];
    if (!file) return;

    // Ensure OpenCV is ready before proceeding
    if (!cvReady) {
      alert('OpenCV is still loading. Please wait a moment and try again.');
      // Reset file input so user can try again
      evt.target.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const dataURL = e.target.result;
      const img = new Image();
      img.src = dataURL;
      img.onload = () => {
        // Clear old results
        colorResults.innerHTML = '';

        // Resize canvas to keep aspect ratio, but max 600Ã—400
        const maxWidth  = 600;
        const maxHeight = 400;
        let w = img.width;
        let h = img.height;
        const aspect = w / h;

        if (w > maxWidth) {
          w = maxWidth;
          h = Math.floor(w / aspect);
        }
        if (h > maxHeight) {
          h = maxHeight;
          w = Math.floor(h * aspect);
        }

        snapshotCanvas.width = w;
        snapshotCanvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);

        // Now run color detection
        detectColors(w, h);
      };
    };
    reader.readAsDataURL(file);
  });

  // Use k-means to find ~5 dominant colors
  function detectColors(canvasW, canvasH) {
    spinner.style.display = 'block';

    // 1) Create mats
    let src = new cv.Mat(canvasH, canvasW, cv.CV_8UC4);
    let imageData = ctx.getImageData(0, 0, canvasW, canvasH);
    src.data.set(imageData.data);

    // 2) Convert RGBA to BGR for easier kmeans
    let srcBGR = new cv.Mat();
    cv.cvtColor(src, srcBGR, cv.COLOR_RGBA2BGR);

    // 3) Flatten Nx3 for kmeans
    // Convert to float for kmeans
    let samples = new cv.Mat();
    srcBGR.convertTo(samples, cv.CV_32F);
    samples = samples.reshape(1, canvasW * canvasH); // Nx3

    // 4) K-means
    let K = 5;  // number of dominant colors to extract
    let bestLabels = new cv.Mat();
    let centers = new cv.Mat();
    // Stop criteria: up to 10 iterations or move centers by <=1.0
    let criteria = new cv.TermCriteria(cv.TermCriteria_EPS + cv.TermCriteria_MAX_ITER, 10, 1.0);
    let attempts = 3;
    let flags = cv.KMEANS_RANDOM_CENTERS;

    cv.kmeans(samples, K, bestLabels, criteria, attempts, flags, centers);

    // 5) Convert centers to 8U to read them easily
    centers.convertTo(centers, cv.CV_8U);

    // Extract each center's BGR
    let colorSet = [];
    for (let i = 0; i < K; i++) {
      let b = centers.data[i*3 + 0];
      let g = centers.data[i*3 + 1];
      let r = centers.data[i*3 + 2];
      colorSet.push({r, g, b});
    }

    // Cleanup
    src.delete();
    srcBGR.delete();
    samples.delete();
    bestLabels.delete();
    centers.delete();

    spinner.style.display = 'none';

    // Display the ~5 dominant colors
    colorResults.innerHTML = '<h3>Detected Dominant Colors:</h3>';
    colorSet.forEach(col => {
      let {r, g, b} = col;
      let hex = rgbToHex(r, g, b);
      let name = approximateColorName(r, g, b);

      let item = document.createElement('div');
      item.className = 'color-item';
      item.innerHTML = `
        <div class="color-box" style="background: ${hex};"></div>
        <div class="color-info">
          <strong>${name}</strong><br/>
          RGB(${r},${g},${b})<br/>
          ${hex}
        </div>
      `;
      colorResults.appendChild(item);
    });
  }
});
</script>
</body>
</html>
